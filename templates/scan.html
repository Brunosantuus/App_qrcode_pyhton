{% extends 'base.html' %}

{% block title %}Registrar Presença{% endblock %}
{% block header %}Registrar Presença{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow p-4">
    <h3 class="text-lg font-semibold mb-4">Selecionar Turma</h3>
    <select id="turma-select" class="w-full p-2 border rounded">
        <option value="">Selecione uma turma</option>
        {% for turma in turmas %}
        <option value="{{ turma.id }}">{{ turma.nome }} ({{ turma.disciplina }} - {{ turma.polo }})</option>
        {% endfor %}
    </select>
    <div id="qr-reader" class="mt-4"></div>
    <p id="qr-message" class="mt-2 text-gray-500"></p>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
    let html5QrcodeScanner = null;
    document.getElementById('turma-select').addEventListener('change', (e) => {
        const turmaId = e.target.value;
        if (!turmaId) {
            if (html5QrcodeScanner) html5QrcodeScanner.stop();
            document.getElementById('qr-reader').innerHTML = '';
            return;
        }

        document.getElementById('qr-reader').innerHTML = '<div id="reader" class="w-full max-w-md"></div>';
        html5QrcodeScanner = new Html5QrcodeScanner('reader', { fps: 10, qrbox: 250 });
        html5QrcodeScanner.render(async (qrData) => {
            try {
                const response = await fetch('/register_attendance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ qr_data: qrData, turma_id: turmaId })
                });
                const data = await response.json();
                document.getElementById('qr-message').textContent = data.message || data.error;
                document.getElementById('qr-message').className = response.ok ? 'text-green-500' : 'text-red-500';
            } catch (error) {
                document.getElementById('qr-message').textContent = 'Erro ao registrar presença';
                document.getElementById('qr-message').className = 'text-red-500';
            }
        });
    });
</script>
{% endblock %}